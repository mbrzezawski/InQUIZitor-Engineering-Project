\documentclass[12pt]{article}

% Margins & typography
\usepackage{geometry}
\geometry{margin=2.2cm}
\setlength{\parindent}{0pt}

% Language & fonts
\usepackage{polyglossia}
\setdefaultlanguage{polish}
\usepackage{fontspec}
\setmainfont{DejaVu Serif}

% Colors & graphics
\usepackage{xcolor}
\definecolor{brand}{HTML}{ {{ brand_hex | default("4CAF4F") }} }
\definecolor{bggray}{RGB}{245,246,247}
\pagecolor{bggray}

\usepackage{graphicx}
\usepackage{tikz}
\usetikzlibrary{calc}

% Subtelny zielony akcent w tle (pierwsza strona)
\usepackage{atbegshi}
\AtBeginShipoutFirst{%
  \AtBeginShipoutAddToBox{%
    \begin{tikzpicture}[remember picture, overlay]
      \fill[brand!6] ([xshift=-20mm,yshift=10mm]current page.north west)
        rectangle ([xshift=60mm,yshift=-40mm]current page.north west);
    \end{tikzpicture}%
  }%
}

% Microtypografia i zawijanie
\usepackage{microtype}
\usepackage{ragged2e}
\setlength{\emergencystretch}{2em}
\sloppy

% Lists
\usepackage{enumitem}
\newlist{choicelist}{enumerate}{1}
\setlist[choicelist]{
  label=\Alph*., leftmargin=*, align=left, labelsep=0.6em,
  itemsep=4pt, topsep=6pt, parsep=0pt, partopsep=0pt
}

% Header (logo + tytuł)
\usepackage{fancyhdr}
\setlength{\headheight}{70pt}   % ~1cm logo = ok. 28pt (dostosuj, jeśli potrzeba)
\setlength{\headsep}{16pt}  

\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0pt}
\fancyhead[L]{%
  [% if logo_path %]
    \includegraphics[height=1.0cm]{ {{ logo_path }} }%
  [% endif %]
}
\fancyhead[R]{\textcolor{brand}{\textbf{ {{ title|latex }} }}}
\fancyfoot[C]{\textcolor{gray}{\thepage}}

% Linki bez ramek
\usepackage{hyperref}
\hypersetup{hidelinks}

% --- NIE DZIEL PYTANIA NA DWIE STRONY ---
\usepackage{needspace}
% Potrzebujemy (6 linii bazowych) + (2 linie na każdą odpowiedź)
\newcommand{\NeedSpaceForQuestion}[1]{%
  \begingroup
  \count255=\numexpr 6 + 2*#1\relax
  \Needspace{\count255\baselineskip}%
  \endgroup
}

% Makra pomocnicze
\newcommand{\choice}[1]{\item \RaggedRight #1}
\newcommand{\correctmark}{\textcolor{brand}{\textbf{(✓)}}}

\begin{document}

% Większy odstęp pod tytułem z nagłówka

{\Large \textcolor{brand}{\textbf{Instrukcja}}}\par
Odpowiedz na wszystkie pytania. W pytaniach zamkniętych zaznacz jedną poprawną odpowiedź (chyba że treść polecenia stanowi inaczej).

% Odstęp między Instrukcją a sekcją pytań
\vspace{0.8cm}
{\large \textcolor{brand}{\textbf{Pytania}}}
\vspace{0.4cm}

\begin{enumerate}
[% for q in questions %]
  % Policz liczbę odpowiedzi dla zamkniętych pytań (0 dla otwartych)
  [% set nchoices = (q.choices|length if (q.is_closed and q.choices) else 0) %]
  % Zarezerwuj miejsce; jeśli go brak, przerzuć całe pytanie na nast. stronę
  \NeedSpaceForQuestion{ {{nchoices}} }

  \item {{ q.text|latex }}

  [% if q.is_closed and q.choices %]
    \begin{choicelist}
      [% for c in q.choices %]
        \choice {{ c|latex }}[% if show_answers and (q.correct_choices and (c in q.correct_choices)) %] \correctmark[% endif %]
      [% endfor %]
    \end{choicelist}
  [% else %]
    % Miejsce na odpowiedź otwartą
    \vspace{1.2cm}
  [% endif %]

[% endfor %]
\end{enumerate}

[% if show_answers %]
\newpage
{\large \textcolor{brand}{\textbf{Klucz odpowiedzi}}}
\vspace{0.4cm}
\begin{enumerate}
[% for q in questions %]
  \item
  [% if q.is_closed and q.correct_choices and (q.correct_choices|length > 0) %]
    {{ q.correct_choices|join(', ')|latex }}
  [% else %]
    —
  [% endif %]
[% endfor %]
\end{enumerate}
[% endif %]

\end{document}
